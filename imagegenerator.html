<!DOCTYPE html>
<title>Image Generator</title>
<style>
  @import url(https://fonts.googleapis.com/css?family=Roboto);

  body {
    border: 0px;
    background: none repeat scroll 0 0 #fff;
    color: #58585b;
    font-family: "Roboto", Arial, sans-serif;
    font-size: 12px;
    text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.004);
  }

  #MainContainer {
    display: grid;
    grid-template-columns: 480px 550px 1fr;
  }

  .product_carousel img {
    width: 58px;
    height: 58px;
  }

  .Button {
    background-color: #e9aa12;
    color: #fff;
    border: none;
    width: 175px;
    height: 51px;
    padding: 8px;
    font-family: "", Arial, sans-serif;
    font-size: 18px;
  }

  .Button:hover {
    background-color: #edbb41;
    color: #fff;
    border: none;
    width: 175px;
    height: 51px;
    padding: 8px;
    font-family: "Roboto", Arial, sans-serif;
    font-size: 18px;
  }

  #ProductPreviewContainer {
    width: 550px;
    margin: 0px 0px 0px 0px;
    float: left;
    grid-column: 2;
  }

  #ProductVignetteRotationDegrees {
    width: 40px;
  }

  #ProductVignetteRotationDegreesSlider {
    width: 60%;
    margin: 0px auto;
  }

  #ProductImagePreview {
    width: 545;
    height: 480;
  }

  #ImageOptions {
    padding: 5px 10px 5px;
    min-width: 445px;
    max-width: 70%;
    margin: 0px 0px 0px 10px;
    float: left;
    vertical-align: middle;
    grid-column: 1;
  }

  .menupad {
    display: inline-block;
    height: 30px;
    margin: 10px 0px 0px 0px;
    vertical-align: text-top;
  }

  #controls-submit {
    text-align: center;
    padding: 10px;
  }

  #vignetteUrl {
    width: 300px;
    text-align: center;
  }

  #previewImage {
    max-height: 475px;
    max-width: 540px;
    margin: 10px auto;
    display: block;
  }

  .thumbnailPreview {
    float: left;
    max-height: 90px;
    max-width: 90px;
    margin: 20px 0px 0px 50px;
    display: block;
  }

  #thumbnailHero {
    padding: 0px;
  }

  #thumbnailHero:hover {
    padding: 0px;
    border: thin solid #b1b4b6;
  }

  #thumbnailVirtual {
    padding: 0px;
  }

  #thumbnailVirtual:hover {
    padding: 0px;
    border: thin solid #b1b4b6;
  }

  #thumbnailDecoration {
    padding: 0px;
    width: 95px !important;
  }

  #thumbnailDecoration:hover {
    border: thin solid #b1b4b6;
  }

  select {
    height: 25px;
  }

  .selected-type {
    font-family: "Roboto", Arial, sans-serif;
    font-size: 20px;
    font-weight: 300;
    clear: both;
    padding-top: 10px;
    border-bottom: thin solid #b1b4b6;
    opacity: .8;
  }

  .selected-type-sub {
    font-style: italic;
    font-size: 15px;
    font-weight: 300;
    clear: both;
    padding-left: 25px;
    padding-top: 10px;
  }

  .tumblerPreviewZoom {
    margin: 5px auto;
  }

  .tumblerPreview {
    text-align: center;
  }

  /* START Carousel CSS */

  /* START Form Carousel */

  .list_carousel {
    float: left;
    width: 360px;
  }

  .list_carousel ul {
    margin: 0;
    padding: 0;
    list-style: none;
    display: block;
  }

  .list_carousel li {
    width: 60px;
    padding: 0;
    display: block;
    float: left;
    text-align: center;
  }

  .list_carousel li img {
    width: 58px;
    height: 66px;
    padding-bottom: 8px;
  }

  .list_carousel.responsive {
    width: auto;
    margin-left: 0;
  }

  /* START Inner Carousel */

  .list_carousel2 {
    float: left;
    width: 360px;
  }

  .list_carousel2 ul {
    margin: 0;
    padding: 0;
    list-style: none;
    display: block;
  }

  .list_carousel2 li {
    width: 35px;
    height: 35px;
    padding: 0;
    display: block;
    float: left;
    text-align: center;
  }

  .list_carousel2 li img {
    width: 25px;
    height: 25px;
    padding: 1px;
  }

  .list_carousel2 li img:hover {
    width: 25px;
    height: 25px;
    padding: 0px;
  }

  .list_carousel2.responsive {
    width: auto;
    margin-left: 0;
  }

  .prev {
    display: block;
    height: 26px;
    width: 13px;
    float: left;
    background: transparent url('//imagegenerator.tervis.com/is/image/tervis/ui-caret-left') center top no-repeat;
    top: auto;
    bottom: auto;
  }

  .prev:hover {
    display: block;
    height: 26px;
    width: 13px;
    float: left;
    background: transparent url('//imagegenerator.tervis.com/is/image/tervis/ui-caret-left-over') center top no-repeat;
  }

  .next {
    display: block;
    height: 26px;
    width: 13px;
    float: left;
    background: transparent url('//imagegenerator.tervis.com/is/image/tervis/ui-caret-right') center top no-repeat;
  }

  .next:hover {
    display: block;
    height: 26px;
    width: 13px;
    float: left;
    background: transparent url('//imagegenerator.tervis.com/is/image/tervis/ui-caret-right-over') center top no-repeat;
  }

  .swatch-label {
    font-size: 10px;
    font-style: italic;
    text-align: center;
    line-height: 15px;
  }

  .prev2,
  .next2 {
    margin-top: 30px;
  }

  /* END Carousel CSS */

  label>input {
    display: none;
  }

  label>input:checked+img {
    padding: 1px;
    border-color: #b1b4b6;
    border-style: double;
    border-width: 1px;
  }

  .loader,
  .loader:after {
    border-radius: 50%;
    width: 10em;
    height: 10em;
  }
  .loader {
    margin: 60px auto;
    font-size: 10px;
    position: relative;
    text-indent: -9999em;
    border-top: 1.1em solid rgba(64,0,64, 0.2);
    border-right: 1.1em solid rgba(64,0,64, 0.2);
    border-bottom: 1.1em solid rgba(64,0,64, 0.2);
    border-left: 1.1em solid #400040;
    -webkit-transform: translateZ(0);
    -ms-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-animation: load8 1.1s infinite linear;
    animation: load8 1.1s infinite linear;
  }
  @-webkit-keyframes load8 {
    0% {
      -webkit-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    100% {
      -webkit-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }
  @keyframes load8 {
    0% {
      -webkit-transform: rotate(0deg);
      transform: rotate(0deg);
    }
    100% {
      -webkit-transform: rotate(360deg);
      transform: rotate(360deg);
    }
  }

  .loadersmall {
    width: 5px;
    height: 5px;
    margin: 0%;
    float: right;
  }
</style>
<div id="HiddenUIMessage" style="display:none;">
  <h1>Download starting, once finished please close this window</h1>
  <div id="WholePageLoader" class="loader">Loading...</div>
</div>
<div id="MainContainer">
  <div id="ImageOptions">
    <div id="PreviewImageTypeContainer"></div>
    <div id="DecorationSourceMenuGroup"></div>
    <div id="DecorationImageSourceIsArcedContainer"></div>

    <div class="selected-type">Product</div>
    <div class="carousel1" id="select-product"></div>
    <div id="ProductDecorationTypePickerContainer"></div>

    <div id="select-vignette-object-color-options"></div>
  </div>
  
  <div id="ProductPreviewContainer">
    <div class="tumblerPreview">
      <div class="tumblerPreviewZoom">
        <img
          id="ProductImagePreview"
          src="https://imagegenerator.tervis.com/is/image/tervis/tervis?layer=0&src=ir{tervisRender/16DWT1?&obj=MAIN/GLARE&show&obj=MAIN/INNER/LINED/CL1&show&obj=MAIN/OUTER/SMOOTH/CL1&show&obj=MAIN&req=object}"
        />
      </div>
      <div>
        Degrees:
        <input
          type="text"
          id="ProductVignetteRotationDegrees"
          maxlength="5"
          value="0"
          onchange="document.querySelector('#ProductVignetteRotationDegreesSlider').value = this.value; Update_ImageGeneratorProductVignetteURL(); Set_ImageGeneratorPersistedState();"
        >

        Snap to:
        <select 
          id="SnapTo"
          onchange="document.querySelector('#ProductVignetteRotationDegreesSlider').step = this.value"
        >
          <option selected>90</option>
          <option>45</option>
          <option>11.25</option>
        </select>

        Start Offset
        <select
          id="ProductVignetteDegreesStartOffset"
          onchange="document.querySelector('#ProductVignetteRotationDegrees').value = this.value; document.querySelector('#ProductVignetteRotationDegreesSlider').value = this.value; Update_ImageGeneratorProductVignetteURL(); Set_ImageGeneratorPersistedState()"
        >
          <option>0</option>
          <option>90</option>
        </select>
      </div>
      <input
        type="range"
        id="ProductVignetteRotationDegreesSlider"
        value="0"
        min="-180"
        max="180"
        step="90"
        onchange="document.querySelector('#ProductVignetteRotationDegrees').value = this.value; Update_ImageGeneratorProductVignetteURL(); Set_ImageGeneratorPersistedState()"
      />

      <div class="menupad" id="DownloadButtonFormContainer"></div>
    </div>
  </div>

  <div style="grid-column: 3">
    <textarea
      id="ProductVignetteURL"
      spellcheck="false"
      readonly
      style="width: 100%; height: 100%;"
    ></textarea>
  </div>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

  <!-- Things to support caroufredsel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.caroufredsel/6.2.1/jquery.carouFredSel.packed.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.touchswipe/1.6.19/jquery.touchSwipe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.12/jquery.transit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>
</div>

<script type="module">
  import {
    Get_TervisProductMetaDataUsingIndex,
    Get_TervisProductSizeAndFormTypeFromString,
    Get_TervisProductColorMarketingNameUsingIndex
  } from 'https://unpkg.com/@tervis/tervisproductmetadata?module'

  import {
    html,
    render,
    directive
  } from 'https://unpkg.com/lit-html?module'

  import {
    ifDefined
  } from 'https://unpkg.com/lit-html@1.1.2/directives/if-defined.js?module'

  import {
    New_TervisAdobeScene7PrintSingleURL,
    New_TervisAdobeScene7WrapDecoration3TimesURL,
    New_TervisAdobeScene7URL,
    New_TervisAdobeScene7ProductVignetteImageURL,
    ConvertTo_TervisAdobeScene7VignettePosition,
    Get_TervisAdobeScene7Silhouette,
    Get_TervisAdobeScene7VignetteObjectWithColorOption,
    Get_TervisAdobeScene7SwatchImageURL,
    New_TervisAdobeScene7VirtualImageURL,
    New_TervisAdobeScene7DecorationProofImageURL,
    New_TervisAdobeScene7ArcedImageURL,
    Get_TervisAdobeScene7VignettePosition
  } from 'https://unpkg.com/@tervis/tervisadobescene7js?module'

  import {
    New_TervisAdobeScene7CustomyzerDecorationImageURL,
    New_TervisAdobeScene7CustomyzerArtboardImageURL
  } from 'https://unpkg.com/@tervis/tervisadobescene7customyzerjs?module'

  import {
    Remove_ObjectKeyWithEmptyOrNullValue
  } from 'https://unpkg.com/@tervis/tervisutilityjs?module'

  import {
    Get_TervisCustomyzerProjectProductSizeAndProductFormType
  } from 'https://unpkg.com/@tervis/terviscustomyzerjs?module'

  import {
    Out_AdobeScene7URLPrettyPrint,
    New_AdobeScene7SizeStanza
  } from "https://unpkg.com/@tervis/adobescene7js?module"

  import {
    New_TervisPrintableFileURL
  } from "https://unpkg.com/@tervis/tervisprintablefilejs?module"

  async function Receive_ImageGeneratorPreviewImageTypeContainerOnChange() {
    await Update_ImageGeneratorThingsWithColorOptionsCarousel()
    await Update_ImageGeneratorProductVignetteURL()
    Set_ImageGeneratorPersistedState()
  }

  function Update_ImageGeneratorProductImageTypeContainer () {
    var $MenuGroup = New_MenuGroup({
      $GroupTitle: "Product Image Type",
      $InnerContent: New_Carousel({
        $CarouselID: "ProductImageType",
        $CarouselItemsContainerStyle: "list_carousel",
        $ShiftArrowsDown: true,
        $CarouselItems: [
          New_CarouselItem({
            $CarouselName: "ProductImageType",
            $ImageURL: "//imagegenerator.tervis.com/is/image/tervis?layer=0&src=ir(tervisRender/16DWT1?&obj=MAIN/GLARE&show&obj=MAIN/OUTER/SMOOTH/CL1&show&obj=MAIN/INNER/LINED/CL1&show&.ACCESSORY&obj=MAIN&req=object&sharpen=1)$PDP-ALT-THMB$",
            $Title: "High angle",
            $Value: "1",
            $IsChecked: true,
            $OnChange: Receive_ImageGeneratorPreviewImageTypeContainerOnChange
          }),
          New_CarouselItem({
            $CarouselName: "ProductImageType",
            $ImageURL: "//imagegenerator.tervis.com/is/image/tervis?layer=0&src=ir(tervisRender/16DWT1-HERO2?&obj=MAIN/GLARE&show&obj=MAIN/OUTER/SMOOTH/CL1&show&obj=MAIN/INNER/LINED/CL1&show&.ACCESSORY&obj=MAIN&req=object&sharpen=1)$PDP-ALT-THMB$",
            $Title: "Low angle",
            $Value: "1-HERO2",
            $OnChange: Receive_ImageGeneratorPreviewImageTypeContainerOnChange
          })
        ]
      })
    })

    render($MenuGroup, document.querySelector("#PreviewImageTypeContainer"))

    $('.ProductImageType').carouFredSel({
      auto: false,
      circular: false,
      prev: '.ProductImageTypeContainer .prev2',
      next: '.ProductImageTypeContainer .next2',
      mousewheel: true,
      swipe: {
        onMouse: true,
        onTouch: true
      }
    })
  }

  function Get_ImageGeneratorProductImageTypeValue () {
    return document.querySelector("input[name='ProductImageType']:checked").value
  }

  async function Get_ImageGeneratorProductVignetteImageURLNSides({
    $NumberOfSides,
    $AsScene7SrcValue,
    $Width,
    $Height
  }) {
    var {$ProductSize, $ProductFormType} = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    
    var $DegreesStartOffset = document.querySelector("#ProductVignetteDegreesStartOffset").value
    var $StartPosition = await ConvertTo_TervisAdobeScene7VignettePosition({
      $ProductSize,
      $ProductFormType,
      $Degrees: $DegreesStartOffset
    })

    var $VignettePositions = await Get_TervisAdobeScene7VignettePosition({
        $ProductSize,
        $ProductFormType,
        $NumberOfPositions: $NumberOfSides,
        $StartPosition
    })

    var $ProductVignetteImageURLAsSourceValuePromises = $VignettePositions.map(
      async $DecorationPositionXValue =>
      await Get_ImageGeneratorProductVignetteImageURL({
        $Width,
        $Height,
        $AsScene7SrcValue,
        $DecorationPositionXValue
      })
    )

    return await Promise.all($ProductVignetteImageURLAsSourceValuePromises) 
  }

  async function downloadAll(urls) {
    for (var i = 0; i < urls.length; i++) {
      saveAs(urls[i], `${i + 1}.png`)
    }
  }

  async function Invoke_DownloadFourSides() {
    var $URLs = await Get_ImageGeneratorProductVignetteImageURLNSides({
      $NumberOfSides: 4,
      $Width: 1401,
      $Height: 1232
    })
    await downloadAll($URLs)
  }

  async function Invoke_OneSidedVirtualDownload () {
    var $DecorationProofImageURLAsSourceValue = await New_ImageGeneratorDecorationProofImageURLAsSourceValue()
    var $ProductVignetteImageURLAsSourceValue = await Get_ImageGeneratorProductVignetteImageURL({
      $Width: 1079,
      $Height: 949,
      $AsScene7SrcValue: true
    })
    
    var {$ProductSize, $ProductFormType} = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    var $VirtualImageURL = await New_TervisAdobeScene7VirtualImageURL({
      $ProductSize,
      $ProductFormType,
      $DecorationProofImageURLAsSourceValue,
      $ProductVignetteImageURLAsSourceValue
    })

    await downloadAll([$VirtualImageURL])
  }

  async function Invoke_PrintableFileDownload () {
    var {$ProductSize, $ProductFormType} = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    var $DecorationImageSourceType = Get_ImageGeneratorDecorationImageSourceType()
    
    if ($DecorationImageSourceType === "Customyzer Project ID") {
      var $CustomyzerProjectID = document.querySelector("#DecorationImageSourceValue").value
      var $PrintableFileURL = New_TervisPrintableFileURL({
        $ProductSize,
        $ProductFormType,
        $CustomyzerProjectID
      })
      saveAs($PrintableFileURL, "PrintableFile.pdf")
    } else {
      var $DecorationImageSourceURL = await Get_ImageGeneratorDecorationImageSourceURL({})
      //Unfinished, need to create arbitrary white ink url process starting from any color image
      //url
    }
  }

  function Get_ImageGeneratorProductDecorationType () {
    return document.querySelector('#ProductDecorationType').value
  }

  function Get_ImageGeneratorDecorationImageSourceType () {
    if (document.querySelector("#DecorationImageSourceType")) {
      return document.querySelector("#DecorationImageSourceType").value !== "Source Type" ?
      document.querySelector("#DecorationImageSourceType").value :
      undefined
  }
  }

  async function New_ImageGeneratorDecorationProofImageURLAsSourceValue () {
    var {$ProductSize, $ProductFormType} = Get_ImageGeneratorSelectedProductSizeAndProductFormType()

    var {
      DecorationProofWidthOnVirtual: $DecorationProofWidthOnVirtual,
      DecorationProofHeightOnVirtual: $DecorationProofHeightOnVirtual
    } = await Get_TervisProductMetaDataUsingIndex({$ProductSize, $ProductFormType})

    var $DecorationTypeDropDownValue = Get_ImageGeneratorProductDecorationType()
    var $DecorationImageSourceType = Get_ImageGeneratorDecorationImageSourceType()
    var $DecorationImageSourceIsArced = Get_ImageGeneratorDecorationImageSourceArced()

    var $URLOfDecorationAsSrcValue
    if ($DecorationImageSourceIsArced || $ProductFormType === "SS") {
      $URLOfDecorationAsSrcValue = await Get_ImageGeneratorDecorationImageSourceURL({
        $Width: $DecorationProofWidthOnVirtual,
        $Height: $DecorationProofHeightOnVirtual,
        $AsScene7SrcValue: true
      })
    } else {
      $URLOfDecorationAsSrcValue = await New_TervisAdobeScene7ArcedImageURL({
        $ProductSize,
        $ProductFormType,
        $Width: $DecorationProofWidthOnVirtual,
        $Height: $DecorationProofHeightOnVirtual,
        $AsScene7SrcValue: true,
        $DecalSourceValue: await Get_ImageGeneratorDecorationImageSourceURL({$AsScene7SrcValue: true})
      })
    }

    var $DecorationImageURLAsSourceValue = $URLOfDecorationAsSrcValue

    var $ArcedDecorationAndIncludeDieCutterCalibrationLine
    if ($DecorationTypeDropDownValue === "WRA") {
      $ArcedDecorationAndIncludeDieCutterCalibrationLine = true
    } else {
      $ArcedDecorationAndIncludeDieCutterCalibrationLine = false
    }

    var $DecorationProofImageURLAsSourceValue = await New_TervisAdobeScene7DecorationProofImageURL({
      $DecorationImageURLAsSourceValue,
      $ArcedDecoration: $ArcedDecorationAndIncludeDieCutterCalibrationLine,
      $IncludeDiecutterCalibrationLine: $ArcedDecorationAndIncludeDieCutterCalibrationLine,
      $ProductSize,
      $ProductFormType,
      $Width: $DecorationProofWidthOnVirtual,
      $Height: $DecorationProofHeightOnVirtual,
      $AsScene7SrcValue: true
    })

    return $DecorationProofImageURLAsSourceValue
  }

  function Wait_ForImagesLoaded({
    $ImageURLs,
    $Callback
  }) {
    var imageElements = [];
    var remaining = $ImageURLs.length;
    var onEachImageLoad = function(){
      if (--remaining === 0 && $Callback) {
        $Callback(imageElements);
      }
    };

    // first create the images and apply the onload method
    for (var i = 0, len = $ImageURLs.length; i < len; i++){
      var img = new Image();
      imageElements.push(img);
      img.onload = onEachImageLoad;
      img.setAttribute('crossOrigin', '')
      img.src = $ImageURLs[i];
    }
  }

  function ConvertFrom_ImageGeneratorStateToJson () {
    var $ProductSizeAndProductFormType = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    var $DecorationImageSourceType = Get_ImageGeneratorDecorationImageSourceType()
    var $DecorationImageSourceValue =
      document.querySelector("#DecorationImageSourceValue") ?
      document.querySelector("#DecorationImageSourceValue").value :
      undefined
    var $DecorationImageSourceArcedValue = Get_ImageGeneratorDecorationImageSourceArced()
    var $ProductVignetteRotationDegrees = document.querySelector("#ProductVignetteRotationDegrees").value
    var $ProductVignetteDegreesStartOffset = document.querySelector("#ProductVignetteDegreesStartOffset").value
    var $ProductVignetteSelectedThingsWithColorCodeRelativePath = Get_ImageGeneratorSelectedThingsWithColorCodeRelativePath()
    var $ProductVignetteNameSuffix = Get_ImageGeneratorProductImageTypeValue()
    var $ProductDecorationTypeCode = Get_ImageGeneratorProductDecorationType()
    var $DownloadButtonActionName = Get_ImageGeneratorDownloadButtonActionName()
    
    return JSON.stringify(
      {
        ...$ProductSizeAndProductFormType,
        $DecorationImageSourceType,
        $DecorationImageSourceValue,
        $DecorationImageSourceArcedValue,
        $ProductVignetteRotationDegrees,
        $ProductVignetteDegreesStartOffset,
        $ProductVignetteSelectedThingsWithColorCodeRelativePath,
        $ProductVignetteNameSuffix,
        $ProductDecorationTypeCode,
        $DownloadButtonActionName
      },
      undefined,
      2
    )
  }

  window.ConvertFrom_ImageGeneratorStateToJson = ConvertFrom_ImageGeneratorStateToJson

  function Set_ImageGeneratorPersistedState () {
    var $StateJson = ConvertFrom_ImageGeneratorStateToJson()
    localStorage.setItem('ImageGeneratorPersistedState', $StateJson)
  }
  //Needed for degrees form element events, to eliminate this refactor slider into lit-html template
  window.Set_ImageGeneratorPersistedState = Set_ImageGeneratorPersistedState

  async function Get_ImageGeneratorPersistedState () {
    var $StateJson = localStorage.getItem('ImageGeneratorPersistedState')
    if ($StateJson) {
      await ConvertFrom_ImageGeneratorJsonToState({$StateJson})
    }
  }

  async function ConvertFrom_ImageGeneratorJsonToState ({
    $StateJson
  }) {
    var {
      $ProductSize,
      $ProductFormType,
      $DecorationImageSourceType,
      $DecorationImageSourceValue,
      $DecorationImageSourceArcedValue,
      $ProductVignetteRotationDegrees,
      $ProductVignetteDegreesStartOffset,
      $ProductVignetteSelectedThingsWithColorCodeRelativePath,
      $ProductVignetteNameSuffix,
      $ProductDecorationTypeCode,
      $DownloadButtonActionName
    } = JSON.parse($StateJson)

    await Set_ImageGeneratorSelectedProductSizeAndProductFormType({ $ProductSize, $ProductFormType })
    Set_ImageGeneratorDecorationImageSource({
      $Type: $DecorationImageSourceType,
      $Value: $DecorationImageSourceValue,
      $ArcedValue: $DecorationImageSourceArcedValue
    })
    Set_NodeValueAndFireOnChange({$ID: "ProductVignetteDegreesStartOffset", $Value: $ProductVignetteDegreesStartOffset})
    Set_NodeValueAndFireOnChange({$ID: "ProductVignetteRotationDegrees", $Value: $ProductVignetteRotationDegrees})
    if($ProductVignetteNameSuffix) {
      document
      .querySelector(
        `input[name='ProductImageType'][value='${$ProductVignetteNameSuffix}']`
      ).checked = true
    }
    Set_NodeValueAndFireOnChange({$ID: "ProductDecorationType", $Value: $ProductDecorationTypeCode})

    $ProductVignetteSelectedThingsWithColorCodeRelativePath.forEach(
      $Path => {
        var $Parts = $Path.split("/")
        var $Element = document.querySelector(`.${$Parts[0]} .${$Parts[1]} input[value='${$Parts[2]}']`)
        $Element.checked = true
        $Element.dispatchEvent(new Event('change', { bubbles: true }))
      }
    )

    Set_NodeValueAndFireOnChange({$ID: "DownloadButtonActionName", $Value: $DownloadButtonActionName})
  }

  function Set_NodeValueAndFireOnChange ({
    $ID,
    $Value
  }) {
    if ($Value !== undefined) {
      var $Element = document.querySelector(`#${$ID}`)
      $Element.value = $Value
      $Element.dispatchEvent(new Event('change', { bubbles: true }))
    }
  }

  function Set_ImageGeneratorDecorationImageSource({
    $Type,
    $Value,
    $ArcedValue
  }) {
    Set_NodeValueAndFireOnChange({$ID: "DecorationImageSourceType", $Value: $Type})
    Set_NodeValueAndFireOnChange({$ID: "DecorationImageSourceValue", $Value})
    Set_NodeValueAndFireOnChange({$ID: "DecorationImageSourceArced", $Value: $ArcedValue})
  }

  async function Set_ImageGeneratorSelectedProductSizeAndProductFormType ({
    $ProductSize,
    $ProductFormType
  }) {
    var $Element = document.querySelector(`input[value='${$ProductSize}${$ProductFormType}']`)
    $Element.checked = true

    // Weird race conditions when firing dispatchEvent where the function called by the event
    // doesn't complete execution before dispatchEvent returns which isn't supposed to be possible
    // Calling the same function that the event triggers directly works reliably
    await Receive_ImageGeneratorProductCarouselChange ()
    // var $Response = $Element.dispatchEvent(new Event('change', { bubbles: true }))
  }

  async function Invoke_ImageGeneratorMultiSidedVirtualDownload ({
    $NumberOfSides
  }) {
    var {$ProductSize, $ProductFormType} = Get_ImageGeneratorSelectedProductSizeAndProductFormType()

    var $DecorationProofImageURLAsSourceValue = await New_ImageGeneratorDecorationProofImageURLAsSourceValue()

    var $ProductVignetteImageURLAsSourceValuesArray = await Get_ImageGeneratorProductVignetteImageURLNSides({
      $NumberOfSides,
      $Width: 1079,
      $Height: 949,
      $AsScene7SrcValue: true
    })

    var $VirtualImageURLsPromises = $ProductVignetteImageURLAsSourceValuesArray.map(
      async $ProductVignetteImageURLAsSourceValue =>
      await New_TervisAdobeScene7VirtualImageURL({
        $ProductSize,
        $ProductFormType,
        $DecorationProofImageURLAsSourceValue,
        $ProductVignetteImageURLAsSourceValue
      })
    )
    var $VirtualImageURLs = await Promise.all($VirtualImageURLsPromises)

    var $WorkerJavascript =  `(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var NeuQuant=require("./TypedNeuQuant.js");var LZWEncoder=require("./LZWEncoder.js");function ByteArray(){this.page=-1;this.pages=[];this.newPage()}ByteArray.pageSize=4096;ByteArray.charMap={};for(var i=0;i<256;i++)ByteArray.charMap[i]=String.fromCharCode(i);ByteArray.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(ByteArray.pageSize);this.cursor=0};ByteArray.prototype.getData=function(){var rv="";for(var p=0;p<this.pages.length;p++){for(var i=0;i<ByteArray.pageSize;i++){rv+=ByteArray.charMap[this.pages[p][i]]}}return rv};ByteArray.prototype.writeByte=function(val){if(this.cursor>=ByteArray.pageSize)this.newPage();this.pages[this.page][this.cursor++]=val};ByteArray.prototype.writeUTFBytes=function(string){for(var l=string.length,i=0;i<l;i++)this.writeByte(string.charCodeAt(i))};ByteArray.prototype.writeBytes=function(array,offset,length){for(var l=length||array.length,i=offset||0;i<l;i++)this.writeByte(array[i])};function GIFEncoder(width,height){this.width=~~width;this.height=~~height;this.transparent=null;this.transIndex=0;this.repeat=-1;this.delay=0;this.image=null;this.pixels=null;this.indexedPixels=null;this.colorDepth=null;this.colorTab=null;this.neuQuant=null;this.usedEntry=new Array;this.palSize=7;this.dispose=-1;this.firstFrame=true;this.sample=10;this.dither=false;this.globalPalette=false;this.out=new ByteArray}GIFEncoder.prototype.setDelay=function(milliseconds){this.delay=Math.round(milliseconds/10)};GIFEncoder.prototype.setFrameRate=function(fps){this.delay=Math.round(100/fps)};GIFEncoder.prototype.setDispose=function(disposalCode){if(disposalCode>=0)this.dispose=disposalCode};GIFEncoder.prototype.setRepeat=function(repeat){this.repeat=repeat};GIFEncoder.prototype.setTransparent=function(color){this.transparent=color};GIFEncoder.prototype.addFrame=function(imageData){this.image=imageData;this.colorTab=this.globalPalette&&this.globalPalette.slice?this.globalPalette:null;this.getImagePixels();this.analyzePixels();if(this.globalPalette===true)this.globalPalette=this.colorTab;if(this.firstFrame){this.writeLSD();this.writePalette();if(this.repeat>=0){this.writeNetscapeExt()}}this.writeGraphicCtrlExt();this.writeImageDesc();if(!this.firstFrame&&!this.globalPalette)this.writePalette();this.writePixels();this.firstFrame=false};GIFEncoder.prototype.finish=function(){this.out.writeByte(59)};GIFEncoder.prototype.setQuality=function(quality){if(quality<1)quality=1;this.sample=quality};GIFEncoder.prototype.setDither=function(dither){if(dither===true)dither="FloydSteinberg";this.dither=dither};GIFEncoder.prototype.setGlobalPalette=function(palette){this.globalPalette=palette};GIFEncoder.prototype.getGlobalPalette=function(){return this.globalPalette&&this.globalPalette.slice&&this.globalPalette.slice(0)||this.globalPalette};GIFEncoder.prototype.writeHeader=function(){this.out.writeUTFBytes("GIF89a")};GIFEncoder.prototype.analyzePixels=function(){if(!this.colorTab){this.neuQuant=new NeuQuant(this.pixels,this.sample);this.neuQuant.buildColormap();this.colorTab=this.neuQuant.getColormap()}if(this.dither){this.ditherPixels(this.dither.replace("-serpentine",""),this.dither.match(/-serpentine/)!==null)}else{this.indexPixels()}this.pixels=null;this.colorDepth=8;this.palSize=7;if(this.transparent!==null){this.transIndex=this.findClosest(this.transparent,true)}};GIFEncoder.prototype.indexPixels=function(imgq){var nPix=this.pixels.length/3;this.indexedPixels=new Uint8Array(nPix);var k=0;for(var j=0;j<nPix;j++){var index=this.findClosestRGB(this.pixels[k++]&255,this.pixels[k++]&255,this.pixels[k++]&255);this.usedEntry[index]=true;this.indexedPixels[j]=index}};GIFEncoder.prototype.ditherPixels=function(kernel,serpentine){var kernels={FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]]};if(!kernel||!kernels[kernel]){throw"Unknown dithering kernel: "+kernel}var ds=kernels[kernel];var index=0,height=this.height,width=this.width,data=this.pixels;var direction=serpentine?-1:1;this.indexedPixels=new Uint8Array(this.pixels.length/3);for(var y=0;y<height;y++){if(serpentine)direction=direction*-1;for(var x=direction==1?0:width-1,xend=direction==1?width:0;x!==xend;x+=direction){index=y*width+x;var idx=index*3;var r1=data[idx];var g1=data[idx+1];var b1=data[idx+2];idx=this.findClosestRGB(r1,g1,b1);this.usedEntry[idx]=true;this.indexedPixels[index]=idx;idx*=3;var r2=this.colorTab[idx];var g2=this.colorTab[idx+1];var b2=this.colorTab[idx+2];var er=r1-r2;var eg=g1-g2;var eb=b1-b2;for(var i=direction==1?0:ds.length-1,end=direction==1?ds.length:0;i!==end;i+=direction){var x1=ds[i][1];var y1=ds[i][2];if(x1+x>=0&&x1+x<width&&y1+y>=0&&y1+y<height){var d=ds[i][0];idx=index+x1+y1*width;idx*=3;data[idx]=Math.max(0,Math.min(255,data[idx]+er*d));data[idx+1]=Math.max(0,Math.min(255,data[idx+1]+eg*d));data[idx+2]=Math.max(0,Math.min(255,data[idx+2]+eb*d))}}}}};GIFEncoder.prototype.findClosest=function(c,used){return this.findClosestRGB((c&16711680)>>16,(c&65280)>>8,c&255,used)};GIFEncoder.prototype.findClosestRGB=function(r,g,b,used){if(this.colorTab===null)return-1;if(this.neuQuant&&!used){return this.neuQuant.lookupRGB(r,g,b)}var c=b|g<<8|r<<16;var minpos=0;var dmin=256*256*256;var len=this.colorTab.length;for(var i=0,index=0;i<len;index++){var dr=r-(this.colorTab[i++]&255);var dg=g-(this.colorTab[i++]&255);var db=b-(this.colorTab[i++]&255);var d=dr*dr+dg*dg+db*db;if((!used||this.usedEntry[index])&&d<dmin){dmin=d;minpos=index}}return minpos};GIFEncoder.prototype.getImagePixels=function(){var w=this.width;var h=this.height;this.pixels=new Uint8Array(w*h*3);var data=this.image;var srcPos=0;var count=0;for(var i=0;i<h;i++){for(var j=0;j<w;j++){this.pixels[count++]=data[srcPos++];this.pixels[count++]=data[srcPos++];this.pixels[count++]=data[srcPos++];srcPos++}}};GIFEncoder.prototype.writeGraphicCtrlExt=function(){this.out.writeByte(33);this.out.writeByte(249);this.out.writeByte(4);var transp,disp;if(this.transparent===null){transp=0;disp=0}else{transp=1;disp=2}if(this.dispose>=0){disp=dispose&7}disp<<=2;this.out.writeByte(0|disp|0|transp);this.writeShort(this.delay);this.out.writeByte(this.transIndex);this.out.writeByte(0)};GIFEncoder.prototype.writeImageDesc=function(){this.out.writeByte(44);this.writeShort(0);this.writeShort(0);this.writeShort(this.width);this.writeShort(this.height);if(this.firstFrame||this.globalPalette){this.out.writeByte(0)}else{this.out.writeByte(128|0|0|0|this.palSize)}};GIFEncoder.prototype.writeLSD=function(){this.writeShort(this.width);this.writeShort(this.height);this.out.writeByte(128|112|0|this.palSize);this.out.writeByte(0);this.out.writeByte(0)};GIFEncoder.prototype.writeNetscapeExt=function(){this.out.writeByte(33);this.out.writeByte(255);this.out.writeByte(11);this.out.writeUTFBytes("NETSCAPE2.0");this.out.writeByte(3);this.out.writeByte(1);this.writeShort(this.repeat);this.out.writeByte(0)};GIFEncoder.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);var n=3*256-this.colorTab.length;for(var i=0;i<n;i++)this.out.writeByte(0)};GIFEncoder.prototype.writeShort=function(pValue){this.out.writeByte(pValue&255);this.out.writeByte(pValue>>8&255)};GIFEncoder.prototype.writePixels=function(){var enc=new LZWEncoder(this.width,this.height,this.indexedPixels,this.colorDepth);enc.encode(this.out)};GIFEncoder.prototype.stream=function(){return this.out};module.exports=GIFEncoder},{"./LZWEncoder.js":2,"./TypedNeuQuant.js":3}],2:[function(require,module,exports){var EOF=-1;var BITS=12;var HSIZE=5003;var masks=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];function LZWEncoder(width,height,pixels,colorDepth){var initCodeSize=Math.max(2,colorDepth);var accum=new Uint8Array(256);var htab=new Int32Array(HSIZE);var codetab=new Int32Array(HSIZE);var cur_accum,cur_bits=0;var a_count;var free_ent=0;var maxcode;var clear_flg=false;var g_init_bits,ClearCode,EOFCode;function char_out(c,outs){accum[a_count++]=c;if(a_count>=254)flush_char(outs)}function cl_block(outs){cl_hash(HSIZE);free_ent=ClearCode+2;clear_flg=true;output(ClearCode,outs)}function cl_hash(hsize){for(var i=0;i<hsize;++i)htab[i]=-1}function compress(init_bits,outs){var fcode,c,i,ent,disp,hsize_reg,hshift;g_init_bits=init_bits;clear_flg=false;n_bits=g_init_bits;maxcode=MAXCODE(n_bits);ClearCode=1<<init_bits-1;EOFCode=ClearCode+1;free_ent=ClearCode+2;a_count=0;ent=nextPixel();hshift=0;for(fcode=HSIZE;fcode<65536;fcode*=2)++hshift;hshift=8-hshift;hsize_reg=HSIZE;cl_hash(hsize_reg);output(ClearCode,outs);outer_loop:while((c=nextPixel())!=EOF){fcode=(c<<BITS)+ent;i=c<<hshift^ent;if(htab[i]===fcode){ent=codetab[i];continue}else if(htab[i]>=0){disp=hsize_reg-i;if(i===0)disp=1;do{if((i-=disp)<0)i+=hsize_reg;if(htab[i]===fcode){ent=codetab[i];continue outer_loop}}while(htab[i]>=0)}output(ent,outs);ent=c;if(free_ent<1<<BITS){codetab[i]=free_ent++;htab[i]=fcode}else{cl_block(outs)}}output(ent,outs);output(EOFCode,outs)}function encode(outs){outs.writeByte(initCodeSize);remaining=width*height;curPixel=0;compress(initCodeSize+1,outs);outs.writeByte(0)}function flush_char(outs){if(a_count>0){outs.writeByte(a_count);outs.writeBytes(accum,0,a_count);a_count=0}}function MAXCODE(n_bits){return(1<<n_bits)-1}function nextPixel(){if(remaining===0)return EOF;--remaining;var pix=pixels[curPixel++];return pix&255}function output(code,outs){cur_accum&=masks[cur_bits];if(cur_bits>0)cur_accum|=code<<cur_bits;else cur_accum=code;cur_bits+=n_bits;while(cur_bits>=8){char_out(cur_accum&255,outs);cur_accum>>=8;cur_bits-=8}if(free_ent>maxcode||clear_flg){if(clear_flg){maxcode=MAXCODE(n_bits=g_init_bits);clear_flg=false}else{++n_bits;if(n_bits==BITS)maxcode=1<<BITS;else maxcode=MAXCODE(n_bits)}}if(code==EOFCode){while(cur_bits>0){char_out(cur_accum&255,outs);cur_accum>>=8;cur_bits-=8}flush_char(outs)}}this.encode=encode}module.exports=LZWEncoder},{}],3:[function(require,module,exports){var ncycles=100;var netsize=256;var maxnetpos=netsize-1;var netbiasshift=4;var intbiasshift=16;var intbias=1<<intbiasshift;var gammashift=10;var gamma=1<<gammashift;var betashift=10;var beta=intbias>>betashift;var betagamma=intbias<<gammashift-betashift;var initrad=netsize>>3;var radiusbiasshift=6;var radiusbias=1<<radiusbiasshift;var initradius=initrad*radiusbias;var radiusdec=30;var alphabiasshift=10;var initalpha=1<<alphabiasshift;var alphadec;var radbiasshift=8;var radbias=1<<radbiasshift;var alpharadbshift=alphabiasshift+radbiasshift;var alpharadbias=1<<alpharadbshift;var prime1=499;var prime2=491;var prime3=487;var prime4=503;var minpicturebytes=3*prime4;function NeuQuant(pixels,samplefac){var network;var netindex;var bias;var freq;var radpower;function init(){network=[];netindex=new Int32Array(256);bias=new Int32Array(netsize);freq=new Int32Array(netsize);radpower=new Int32Array(netsize>>3);var i,v;for(i=0;i<netsize;i++){v=(i<<netbiasshift+8)/netsize;network[i]=new Float64Array([v,v,v,0]);freq[i]=intbias/netsize;bias[i]=0}}function unbiasnet(){for(var i=0;i<netsize;i++){network[i][0]>>=netbiasshift;network[i][1]>>=netbiasshift;network[i][2]>>=netbiasshift;network[i][3]=i}}function altersingle(alpha,i,b,g,r){network[i][0]-=alpha*(network[i][0]-b)/initalpha;network[i][1]-=alpha*(network[i][1]-g)/initalpha;network[i][2]-=alpha*(network[i][2]-r)/initalpha}function alterneigh(radius,i,b,g,r){var lo=Math.abs(i-radius);var hi=Math.min(i+radius,netsize);var j=i+1;var k=i-1;var m=1;var p,a;while(j<hi||k>lo){a=radpower[m++];if(j<hi){p=network[j++];p[0]-=a*(p[0]-b)/alpharadbias;p[1]-=a*(p[1]-g)/alpharadbias;p[2]-=a*(p[2]-r)/alpharadbias}if(k>lo){p=network[k--];p[0]-=a*(p[0]-b)/alpharadbias;p[1]-=a*(p[1]-g)/alpharadbias;p[2]-=a*(p[2]-r)/alpharadbias}}}function contest(b,g,r){var bestd=~(1<<31);var bestbiasd=bestd;var bestpos=-1;var bestbiaspos=bestpos;var i,n,dist,biasdist,betafreq;for(i=0;i<netsize;i++){n=network[i];dist=Math.abs(n[0]-b)+Math.abs(n[1]-g)+Math.abs(n[2]-r);if(dist<bestd){bestd=dist;bestpos=i}biasdist=dist-(bias[i]>>intbiasshift-netbiasshift);if(biasdist<bestbiasd){bestbiasd=biasdist;bestbiaspos=i}betafreq=freq[i]>>betashift;freq[i]-=betafreq;bias[i]+=betafreq<<gammashift}freq[bestpos]+=beta;bias[bestpos]-=betagamma;return bestbiaspos}function inxbuild(){var i,j,p,q,smallpos,smallval,previouscol=0,startpos=0;for(i=0;i<netsize;i++){p=network[i];smallpos=i;smallval=p[1];for(j=i+1;j<netsize;j++){q=network[j];if(q[1]<smallval){smallpos=j;smallval=q[1]}}q=network[smallpos];if(i!=smallpos){j=q[0];q[0]=p[0];p[0]=j;j=q[1];q[1]=p[1];p[1]=j;j=q[2];q[2]=p[2];p[2]=j;j=q[3];q[3]=p[3];p[3]=j}if(smallval!=previouscol){netindex[previouscol]=startpos+i>>1;for(j=previouscol+1;j<smallval;j++)netindex[j]=i;previouscol=smallval;startpos=i}}netindex[previouscol]=startpos+maxnetpos>>1;for(j=previouscol+1;j<256;j++)netindex[j]=maxnetpos}function inxsearch(b,g,r){var a,p,dist;var bestd=1e3;var best=-1;var i=netindex[g];var j=i-1;while(i<netsize||j>=0){if(i<netsize){p=network[i];dist=p[1]-g;if(dist>=bestd)i=netsize;else{i++;if(dist<0)dist=-dist;a=p[0]-b;if(a<0)a=-a;dist+=a;if(dist<bestd){a=p[2]-r;if(a<0)a=-a;dist+=a;if(dist<bestd){bestd=dist;best=p[3]}}}}if(j>=0){p=network[j];dist=g-p[1];if(dist>=bestd)j=-1;else{j--;if(dist<0)dist=-dist;a=p[0]-b;if(a<0)a=-a;dist+=a;if(dist<bestd){a=p[2]-r;if(a<0)a=-a;dist+=a;if(dist<bestd){bestd=dist;best=p[3]}}}}}return best}function learn(){var i;var lengthcount=pixels.length;var alphadec=30+(samplefac-1)/3;var samplepixels=lengthcount/(3*samplefac);var delta=~~(samplepixels/ncycles);var alpha=initalpha;var radius=initradius;var rad=radius>>radiusbiasshift;if(rad<=1)rad=0;for(i=0;i<rad;i++)radpower[i]=alpha*((rad*rad-i*i)*radbias/(rad*rad));var step;if(lengthcount<minpicturebytes){samplefac=1;step=3}else if(lengthcount%prime1!==0){step=3*prime1}else if(lengthcount%prime2!==0){step=3*prime2}else if(lengthcount%prime3!==0){step=3*prime3}else{step=3*prime4}var b,g,r,j;var pix=0;i=0;while(i<samplepixels){b=(pixels[pix]&255)<<netbiasshift;g=(pixels[pix+1]&255)<<netbiasshift;r=(pixels[pix+2]&255)<<netbiasshift;j=contest(b,g,r);altersingle(alpha,j,b,g,r);if(rad!==0)alterneigh(rad,j,b,g,r);pix+=step;if(pix>=lengthcount)pix-=lengthcount;i++;if(delta===0)delta=1;if(i%delta===0){alpha-=alpha/alphadec;radius-=radius/radiusdec;rad=radius>>radiusbiasshift;if(rad<=1)rad=0;for(j=0;j<rad;j++)radpower[j]=alpha*((rad*rad-j*j)*radbias/(rad*rad))}}}function buildColormap(){init();learn();unbiasnet();inxbuild()}this.buildColormap=buildColormap;function getColormap(){var map=[];var index=[];for(var i=0;i<netsize;i++)index[network[i][3]]=i;var k=0;for(var l=0;l<netsize;l++){var j=index[l];map[k++]=network[j][0];map[k++]=network[j][1];map[k++]=network[j][2]}return map}this.getColormap=getColormap;this.lookupRGB=inxsearch}module.exports=NeuQuant},{}],4:[function(require,module,exports){var GIFEncoder,renderFrame;GIFEncoder=require("./GIFEncoder.js");renderFrame=function(frame){var encoder,page,stream,transfer;encoder=new GIFEncoder(frame.width,frame.height);if(frame.index===0){encoder.writeHeader()}else{encoder.firstFrame=false}encoder.setTransparent(frame.transparent);encoder.setRepeat(frame.repeat);encoder.setDelay(frame.delay);encoder.setQuality(frame.quality);encoder.setDither(frame.dither);encoder.setGlobalPalette(frame.globalPalette);encoder.addFrame(frame.data);if(frame.last){encoder.finish()}if(frame.globalPalette===true){frame.globalPalette=encoder.getGlobalPalette()}stream=encoder.stream();frame.data=stream.pages;frame.cursor=stream.cursor;frame.pageSize=stream.constructor.pageSize;if(frame.canTransfer){transfer=function(){var i,len,ref,results;ref=frame.data;results=[];for(i=0,len=ref.length;i<len;i++){page=ref[i];results.push(page.buffer)}return results}();return self.postMessage(frame,transfer)}else{return self.postMessage(frame)}};self.onmessage=function(event){return renderFrame(event.data)}},{"./GIFEncoder.js":1}]},{},[4]);` // worker code as a string.
    var $WorkerJavascriptBlob = new Blob(
      [$WorkerJavascript],
      {
        type: 'application/javascript'
      }
    )

    var $GifJS = new GIF({
      workers: navigator.hardwareConcurrency || 2,
      workerScript: URL.createObjectURL($WorkerJavascriptBlob),
      width: 1650,
      height: 1275,
      globalPalette: true,
      dither: "Atkinson",
      quality: 1
    });

    var $NumberOfPositionsToShow = $NumberOfSides

    document.querySelector("#DownloadButtonFormLoader").style.display = "inline"
    Wait_ForImagesLoaded({
      $ImageURLs: $VirtualImageURLs,
      $Callback: $Images => {
          $GifJS.addFrame($Images[0])
          $GifJS.addFrame($Images[0], {delay: 2000})

          var $TimeForFullRevolutionOfProductInMS = 4000
          var $DelayPerFrame = $TimeForFullRevolutionOfProductInMS / $NumberOfPositionsToShow

          for (var i = 0; i < $Images.length; i++) {
              $GifJS.addFrame($Images[i], {delay: $DelayPerFrame})
          }

          $GifJS.on('finished', function(blob) {
              saveAs(blob, `${$NumberOfPositionsToShow}SidedVirtual.gif`)
              document.querySelector("#DownloadButtonFormLoader").style.display = "none"
          })

          $GifJS.render();
      }
    })
  }

  var $DownloadOptions = [
    {
      Name: "png",
      Function: async () => {
        var $ProductVignetteImageURL = await Get_ImageGeneratorProductVignetteImageURL({
          $Width: 1401,
          $Height: 1232
        })
        saveAs($ProductVignetteImageURL, "ImageGenerator.png")
      }
    },
    {
      Name: "1 Sided Virtual",
      Function: Invoke_OneSidedVirtualDownload
    },
    {
      Name: "4 Sided Virtual",
      Function: () => {
        Invoke_ImageGeneratorMultiSidedVirtualDownload ({
          $NumberOfSides: 4
        })
      }
    },
    {
      Name: "8 Sided Virtual",
      Function: () => {
        Invoke_ImageGeneratorMultiSidedVirtualDownload ({
          $NumberOfSides: 8
        })
      }
    },
    {
      Name: "4 Sides",
      Function: Invoke_DownloadFourSides
    },
    {
      Name: "Decoration printable file",
      Function: Invoke_PrintableFileDownload
    },
    {
      Name: "tif cmyk",
      Function: async () => {
        var $ProductVignetteImageURL = await Get_ImageGeneratorProductVignetteImageURL({
          $Width: 2000,
          $Height: 2000
        })
        saveAs(
          `${$ProductVignetteImageURL}&fmt=tif-alpha,rgb,lzw&qlt=85,1&op_sharpen=0&resMode=sharp2&op_usm=1,1,6,0&iccEmbed=0&printRes=300`,
          "ImageGenerator.tif"
        )
      }
    },
    {
      Name: "jpg 2000x2000",
      Function: async () => {
        var $VignetteImageURLAsSrcValue = await Get_ImageGeneratorProductVignetteImageURL({
          $Width: 2000,
          $Height: 2000,
          $AsScene7SrcValue: true
        })
        var $URL = `${New_TervisAdobeScene7URL({
          $Type: "ImageServer",
          $RelativeURL: `tervis?src=${$VignetteImageURLAsSrcValue}`,
          $Width: 2000,
          $Height: 2000,
        })}&fmt=jpg`
        saveAs($URL, "ImageGenerator.jpg")
      }
    }
  ]

  function Get_ImageGeneratorDownloadButtonActionName () {
    return document.querySelector("#DownloadButtonActionName") ?
      document.querySelector("#DownloadButtonActionName").value :
      undefined
  }

  function Invoke_ImageGeneratorDownload () {
    var $DownloadButtonActionName = Get_ImageGeneratorDownloadButtonActionName()

    var $SelectedDownloadOption = $DownloadOptions
    .filter(
      $DownloadOption =>
      $DownloadOption.Name === $DownloadButtonActionName
    )[0]

    if ($SelectedDownloadOption) {
      $SelectedDownloadOption.Function()
    }
  }

  function Receive_ImageGeneratorDownloadButtonActionNameOnChange() {
    Set_ImageGeneratorPersistedState()
  }

  function Update_ImageGeneratorDownloadButtonForm () {
    var $DownloadButtonForm = html`
      <button
        type="button"
        class="Button"
        @click=${Invoke_ImageGeneratorDownload}
      >Download</button>
      <select 
        id="DownloadButtonActionName"
        @change=${Receive_ImageGeneratorDownloadButtonActionNameOnChange}
      >
        ${$DownloadOptions.map(
          $DownloadOption => html`<option>${$DownloadOption.Name}</option>`
        )}
      </select>
      <div id="DownloadButtonFormLoader" class="loader loadersmall" style="display:none;">Loading...</div>
    `
    var $DownloadButtonFormContainer = document.querySelector("#DownloadButtonFormContainer")
    render($DownloadButtonForm, $DownloadButtonFormContainer)
  }

  var $ProductOrderInCarousel = [
    {
      $ProductSize: 16,
      $ProductFormType: "DWT"
    },
    {
      $ProductSize: 24,
      $ProductFormType: "DWT"
    },
    {
      $ProductSize: 24,
      $ProductFormType: "WB"
    },
    {
      $ProductSize: 16,
      $ProductFormType: "BEER"
    },
    {
      $ProductSize: 16,
      $ProductFormType: "MUG"
    },
    {
      $ProductSize: 12,
      $ProductFormType: "DWT"
    },
    {
      $ProductSize: 10,
      $ProductFormType: "WAV"
    },
    {
      $ProductSize: 6,
      $ProductFormType: "SIP"
    },
    {
      $ProductSize: 87,
      $ProductFormType: "ICE"
    },
    {
      $ProductSize: 9,
      $ProductFormType: "WINE"
    },
    {
      $ProductSize: 9,
      $ProductFormType: "SWG"
    },
    {
      $ProductSize: 20,
      $ProductFormType: "SS"
    },
    {
      $ProductSize: 30,
      $ProductFormType: "SS"
    },
    {
      $ProductSize: 17,
      $ProductFormType: "SS"
    },
    {
      $ProductSize: 24,
      $ProductFormType: "SS"
    },
    {
      $ProductSize: 12,
      $ProductFormType: "SS"
    }
  ]

  const New_MenuGroup = ({
      $GroupTitle,
      $GroupCode,
      $InnerContent,
      $DisplayNone
    }) => {
      return html`
        <div class="${ifDefined($GroupCode)}" style="${ifDefined($DisplayNone ? "display: none;" : undefined) }">
          <div
            class="selected-type"
            title="${ifDefined($GroupCode)}"
          >${$GroupTitle}</div>
          ${$InnerContent}
        </div>
      `
    }

    const New_Carousel = ({
        $CarouselTitle,
        $CarouselID,
        $CarouselItems,
        $CarouselItemsContainerStyle,
        $ShiftArrowsDown
      }) => {
        var $PreviousArrowID
        var $NextArrowID
        var $ArrowClassSuffix = $ShiftArrowsDown ? "2" : ""

        return html`
          ${
            $CarouselTitle ?
            html`
              <div
                class="selected-type-sub"
                title="${$CarouselID}"
              >${$CarouselTitle}</div>
            ` :
            ""
          }
          <div class="${$CarouselID}Container">
            <br>
            <a class="prev prev${$ArrowClassSuffix}" href="#"></a>
            <div class="${$CarouselItemsContainerStyle}">
              <ul class="${$CarouselID}">
                ${$CarouselItems}
              </ul>
            </div>
            <a class="next next${$ArrowClassSuffix}" href="#"></a>
          </div>
        `
      }

      const forceWrite = directive((value) => (part) => {
        part.setValue(value);
      });

      const New_CarouselItem = ({
        $CarouselName,
        $Value,
        $ImageURL,
        $Title,
        $ToolTip,
        $OnChange,
        $IsChecked,
        $ShowTitleAsSpan
      }) => html`
      <li>
        <label>
          <input
            type="radio"
            name="${$CarouselName}"
            .value="${$Value}"
            .checked=${forceWrite($IsChecked)}
            @change=${$OnChange}
          />
          <img
            src="${$ImageURL}"
            title="${ifDefined($ToolTip)}"
          >
          ${$ShowTitleAsSpan ? html`<span class="swatch-label">${$Title}</span>` : ""}
        </label>
      </li>
      `

  async function Receive_ImageGeneratorProductCarouselChange () {
    await Update_ImageGeneratorThingsWithColorOptionsCarousel()
    Update_ImageGeneratorDecorationImageSourceFormArcedSelect()
    Update_ImageGeneratorProductDecorationTypeSelect()
    await Update_ImageGeneratorProductVignetteURL()
    Set_ImageGeneratorPersistedState()
  }

  async function Update_ImageGeneratorProductCarousel () {
    var $CarouselItems = []
    for (var {$ProductSize, $ProductFormType} of $ProductOrderInCarousel) {
      var $IsFirstProduct =
        $ProductOrderInCarousel[0].$ProductSize === $ProductSize &&
        $ProductOrderInCarousel[0].$ProductFormType === $ProductFormType

      var $Product = await Get_TervisProductMetaDataUsingIndex({$ProductSize, $ProductFormType})
      var $ImageURL = await Get_TervisAdobeScene7Silhouette({$ProductSize, $ProductFormType})
      $ImageURL += "&$ICO-SIL-BA$"
      $CarouselItems.push(
        New_CarouselItem({
          $CarouselName: "tumblerRadio",
          $Value: `${$ProductSize}${$ProductFormType}`,
          $ImageURL,
          $Title: $Product.MarketingName,
          $ToolTip: `${$Product.MarketingName} - ${$ProductSize}${$ProductFormType}`,
          $IsChecked: $IsFirstProduct,
          $ShowTitleAsSpan: true,
          $OnChange: Receive_ImageGeneratorProductCarouselChange
        })
      )
    }

    var $ProductCarousel = New_Carousel({
      $CarouselID: "product_carousel",
      $CarouselItems,
      $CarouselItemsContainerStyle: "list_carousel",
      $ShiftArrowsDown: true
    })

    var $ProductCarouselContainer = document.querySelector('#select-product')

    render(
      $ProductCarousel,
      $ProductCarouselContainer
    )

    $('.product_carousel').carouFredSel({
      auto: false,
      circular: false,
      prev: '.product_carouselContainer .prev2',
      next: '.product_carouselContainer .next2',
      mousewheel: true,
      swipe: {
        onMouse: true,
        onTouch: true
      }
    })
  }

  async function Receive_ImageGeneratorDecorationImageSourceArcedOnChange () {
    await Update_ImageGeneratorProductVignetteURL()
    Set_ImageGeneratorPersistedState()
  }

  function Update_ImageGeneratorDecorationImageSourceFormArcedSelect () {
    var {$ProductSize, $ProductFormType} = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    var $DecorationImageSourceType = Get_ImageGeneratorSelectedDecorationImageSourceType()
    var $DisplayNoneAndNotArced =
      $ProductFormType === "SS" ||
      $DecorationImageSourceType === "Customyzer Project ID" ||
      $DecorationImageSourceType === "Raw Material Item Number"

    render(
      html`
        <select
          id="DecorationImageSourceArced"
          class="menupad"
          style="${ifDefined( $DisplayNoneAndNotArced ? "display: none;" : undefined) }"
          @change=${Receive_ImageGeneratorDecorationImageSourceArcedOnChange}
        >
          <option disabled selected>Is source image arced?</option>
          <option value="true">Arced</option>
          <option value="false" ?selected=${$DisplayNoneAndNotArced}>Not Arced</option>
        </select>
      `,
      document.querySelector("#DecorationImageSourceIsArcedContainer")
    )
  }

  function Get_ImageGeneratorSelectedProductSizeAndProductFormType() {
    var $RadioButtonValue = document.querySelector('input[name="tumblerRadio"]:checked').value
    return Get_TervisProductSizeAndFormTypeFromString({ $String: $RadioButtonValue })
  }

  function Get_ImageGeneratorSelectedDecorationImageSourceType () {
    var $DecorationImageSourceTypeElementID = "DecorationImageSourceType"
    var $DecorationImageSourceTypeSelector = `#${$DecorationImageSourceTypeElementID}`

    if (document.querySelector($DecorationImageSourceTypeSelector)) {
      return document.querySelector($DecorationImageSourceTypeSelector).value
    }
  }

  async function Recieve_ImageGeneratorProductDecorationTypeOnChange() {
    await Update_ImageGeneratorProductVignetteURL()
    Set_ImageGeneratorPersistedState()
  }

  function Update_ImageGeneratorProductDecorationTypeSelect () {
    var $ProductSizeAndProductFormType = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    var {$ProductSize, $ProductFormType} = $ProductSizeAndProductFormType

    var $ProductDecorationTypes = {
      WRA: "Wrap",
      EMB: "Emblem",
      DPT: "Direct Print Outer",
      DPC: "Direct Print Inner",
      LET: "Engraved"
    }

    var $SelectValue
    if ($ProductFormType === "SS") {
      $SelectValue = "DPT"
    } else if (["ICE","TALL"].includes($ProductFormType)) {
      $SelectValue = "EMB"
    } else if (!["ICE","SS"].includes($ProductFormType)) {
      $SelectValue = "WRA"
    }

    var $ProductDecorationTypePicker = html`
      <select
        id="ProductDecorationType"
        class="menupad"
        @change=${Recieve_ImageGeneratorProductDecorationTypeOnChange}
        .value=${$SelectValue}
      >
        <option value= "" selected disabled class="menupad">Decoration Type</option>
        ${
          Object
          .entries($ProductDecorationTypes)
          .map(
            ([$ProductDecorationTypeCode, $ProductDecorationTypeName]) =>
            html`
              <option
                value="${$ProductDecorationTypeCode}"
              >${$ProductDecorationTypeName}</option>`
          )
        }
        <option value= "" class="menupad">None</option>
      </select>
    `
    var $ProductDecorationTypePickerContainer = document.querySelector('#ProductDecorationTypePickerContainer')

    render(
      $ProductDecorationTypePicker,
      $ProductDecorationTypePickerContainer
    )
  }

  function Get_ImageGeneratorProductVignetteDegreesStartOffset () {
    return Number(document.querySelector("#ProductVignettDegreesStartOffset").value)
  }

  async function Recieve_ImageGeneratorThingWithColorCodeOnChange () {
    await Update_ImageGeneratorProductVignetteURL()
    Set_ImageGeneratorPersistedState()
  }

  async function Update_ImageGeneratorThingsWithColorOptionsCarousel() {
    var $ProductVignetteDefaultSettings = [
      {
        Size: 16,
        FormType: "DWT",
        INNER: {
          LINED: "CL1"
        }
      },
      {
        Size: 24,
        FormType: "DWT",
        INNER: {
          LINED: "CL1"
        }
      },
      {
        Size: 24,
        FormType: "WB",
        INNER: {
          LINED: "CL1"
        },
        ACCESSORIES: {
          LIDWB: "GY1"
        }
      },
      {
        Size: 16,
        FormType: "BEER",
        INNER: {
          LINED: "CL1"
        }
      },
      {
        Size: 16,
        FormType: "MUG",
        INNER: {
          LINED: "CL1"
        }
      },
      {
        Size: 6,
        FormType: "SIP",
        ACCESSORIES: {
          LIDSIP: "GY3"
        }
      },
      {
        Size: 9,
        FormType: "WINE",
        INNER: {
          LINED: "CL1"
        }
      },
      {
        Size: 9,
        FormType: "SWG",
        INNER: {
          LINED: "CL1"
        }
      },
      {
        Size: 16,
        FormType: "TALL",
        INNER: {
          SMOOTH: "CL1"
        }
      },
      {
        Size: 20,
        FormType: "SS",
        OUTER: {
          SMOOTH: "SS1"
        }
      },
      {
        Size: 30,
        FormType: "SS",
        OUTER: {
          SMOOTH: "SS1"
        }
      },
      {
        Size: 24,
        FormType: "SS",
        ACCESSORIES: {
          LIDWB: "GY1"
        }
      },
      {
        Size: 17,
        FormType: "SS",
        ACCESSORIES: {
          SSWBLID: "SS1"
        }
      },
      {
        Size: 10,
        FormType: "WAV",
        OUTER: {
          WAVY: "CL1"
        }
      }
    ]

    var $VignetteCodeToMarketingName = {
      INNER: "Product Inner",
      LINED: "Lined",
      SMOOTH: "Smooth",
      OUTER: "Product Outer",
      RIPPLE: "Ripple",
      ACCESSORIES: "Accessories",
      HAND: "Handle",
      LIDTRV: "Travel Lid",
      TOPSHK: "Shaker Top Lid",
      LIDSTW: "Straw Lid",
      LIDHOT: "Hot Lid",
      LIDSIP: "Sippy Lid",
      LIDWB: "Water Bottle Lid",
      SSLIDTRV: "Slider Lid",
      SSLIDHMR: "Hammer Lid",
      LIDWIN: "Wine Lid",
      SSWBLID: "Stainless Lid",
      "REG LINED": "Regrind lined"
    }

    var $VignetteSuffix = Get_ImageGeneratorProductImageTypeValue()
    var $ProductSizeAndProductFormType = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    var $VignetteObjectsWithColorOption = await Get_TervisAdobeScene7VignetteObjectWithColorOption({
      ...$ProductSizeAndProductFormType,
      $VignetteSuffix
    })

    var $CarouselGroups = []
    var $CarouFredSelOptions = []

    for (var $VignetteObjectWithColorOption of $VignetteObjectsWithColorOption ){
      var $Carousels = []
      for (var $ThingWithAvailableColorCode of $VignetteObjectWithColorOption.Options) {
        var $CarouselItems = []

        var $CarouselName = $ThingWithAvailableColorCode.Code === "HAND" ?
          $ThingWithAvailableColorCode.Code :
          $VignetteObjectWithColorOption.Code

        if (
          $VignetteObjectWithColorOption.Code !== "INNER" &&
          $VignetteObjectWithColorOption.Code !== "OUTER"
        ) {
          $CarouselItems.push(
            New_CarouselItem({
              $CarouselName,
              $ImageURL: "https://images.tervis.com/is/image/tervis/REMOVE?$SWATCH$",
              $Value: `None`,
              $OnChange: Recieve_ImageGeneratorThingWithColorCodeOnChange
            })
          )
        }

        var $IsChecked = (
          $VignetteObjectWithColorOption.Code === "INNER" ||
          $VignetteObjectWithColorOption.Code === "OUTER"
        ) &&
        $VignetteObjectWithColorOption.Options.length === 1 &&
        $ThingWithAvailableColorCode.AvailableColorCodes.length === 1
        
        for (var $ColorCode of $ThingWithAvailableColorCode.AvailableColorCodes) {
          var $ColorMetaData = await Get_TervisProductColorMarketingNameUsingIndex({$ColorCode})

          if ($ColorMetaData) {
            var { MarketingName: $ColorMarketingName } = $ColorMetaData
          } else {
            continue
          }

          var $CarouselItemImageURL = Get_TervisAdobeScene7SwatchImageURL({$ColorCode})

          $CarouselItems.push(
            New_CarouselItem({
              $CarouselName,
              $Value: `${$ColorCode}`,
              $ImageURL: $CarouselItemImageURL,
              $Title: `${$ColorMarketingName} - ${$ColorCode}`,
              $ToolTip: `${$ColorMarketingName} - ${$ColorCode}`,
              $IsChecked,
              $OnChange: Recieve_ImageGeneratorThingWithColorCodeOnChange
            })
          )
        }

        var $CarouselID = $ThingWithAvailableColorCode.Code.replace(/\s/g, "")
        $CarouFredSelOptions.push({
          CarouselContainerSelector: `.${$VignetteObjectWithColorOption.Code} .${$CarouselID}Container`,
          CaroFreDeslULSelector: `.${$VignetteObjectWithColorOption.Code} .${$CarouselID}Container .${$CarouselID}`
        })
        var $Carousel = New_Carousel({
          $CarouselTitle: $VignetteCodeToMarketingName[$ThingWithAvailableColorCode.Code],
          $CarouselID,
          $CarouselItems,
          $CarouselItemsContainerStyle: "list_carousel2"
        })

        $Carousels.push($Carousel)
      }

      $CarouselGroups.push(
        New_MenuGroup({
          $GroupTitle: $VignetteCodeToMarketingName[$VignetteObjectWithColorOption.Code],
          $GroupCode: $VignetteObjectWithColorOption.Code,
          $InnerContent: $Carousels,
          $DisplayNone: $IsChecked
        })
      )
    }

    var $ThingsWithColorOptionsDiv = document.querySelector('#select-vignette-object-color-options')
    render($CarouselGroups, $ThingsWithColorOptionsDiv)

    $CarouFredSelOptions.forEach(
      $CarouFredSelOption =>
      $($CarouFredSelOption.CaroFreDeslULSelector).carouFredSel({
        auto: false,
        circular: false,
        prev: `${$CarouFredSelOption.CarouselContainerSelector} .prev`,
        next: `${$CarouFredSelOption.CarouselContainerSelector} .next`,
        mousewheel: true,
        swipe: {
          onMouse: true,
          onTouch: true
        }
      })
    )

    $ProductVignetteDefaultSettings.filter(
      ({Size: $ProductSize, FormType: $ProductFormType}) =>
      $ProductSize === parseInt($ProductSizeAndProductFormType.$ProductSize) && $ProductFormType === $ProductSizeAndProductFormType.$ProductFormType
    )
    .forEach(
      $DefaultSettingEntry => {
        var $DefaultSettings = Object.entries($DefaultSettingEntry)
          .filter(
            $Entry =>
            ["Size","FormType"].includes($Entry[0]) === false
          )

        for ( var [$GroupCode, $ThingWithColorCodeObject] of $DefaultSettings) {
          Object
          .entries($ThingWithColorCodeObject)
          .forEach(
            ([$Code, $ColorCode]) =>
            document.querySelector(
              `.${$GroupCode} .${$Code} input[value='${$ColorCode}']`
            ).checked = true
          )
        }
      }
    )
  }// End Update_ImageGeneratorThingsWithColorOptionsCarousel

  async function Receive_ImageGeneartorDecorationImageSourceTypeOnChnage () {
    await Update_ImageGeneratorDecorationImageSourceForm()
    Update_ImageGeneratorDecorationImageSourceFormArcedSelect()
  }

  async function Receive_ImageGeneartorDecorationImageSourceValueOnChange () {
    await Update_ImageGeneratorProductVignetteURL()
    Set_ImageGeneratorPersistedState()
  }

  async function Update_ImageGeneratorDecorationImageSourceForm() {
    var $DecorationSourceOptions = [
      "Raw Material Item Number",
      "UGC Upload",
      "Customyzer Project ID",
      "Deocoration Image URL",
      // "Finished Good Item Number"
    ]

    var $DecorationImageSourceTypeElementID = "DecorationImageSourceType"
    var $DecorationImageSourceType = Get_ImageGeneratorSelectedDecorationImageSourceType()

    if ($DecorationImageSourceType) {
      var $ConditionallyAddedInput = [html`
        <input
          id="DecorationImageSourceValue"
          type="text"
          placeholder="${$DecorationImageSourceType}"
          disabled="${ifDefined($DecorationImageSourceType === "UGC Upload" ? "" : undefined)}"
          class="menupad"
          .value=${forceWrite("")}
          @change=${Receive_ImageGeneartorDecorationImageSourceValueOnChange}
        />
      `]

      if ($DecorationImageSourceType === "UGC Upload") {
        $ConditionallyAddedInput.push(
          html`
            <form name="frmFileUpload" id="frmFileUpload" method="post" enctype="multipart/form-data">
              <input
                name="txtUploadFile"
                type="file"
                id="txtUploadFile"
                accept="image/*"
                class="btn btn-default"
                style="width: 210px; height:30px; vertical-align:bottom;"
                @change=${Add_ImageFromDevice}
              />
              <div id="UGCUploadLoader" class="loader loadersmall" style="display:none;">Loading...</div>
            </form>
          `
        )
      }
    }

    var {$ProductSize, $ProductFormType} = Get_ImageGeneratorSelectedProductSizeAndProductFormType()

    var $MenuGroup = New_MenuGroup({
      $GroupTitle: "Decoration Image",
      $InnerContent: html`
        <select
          id="${$DecorationImageSourceTypeElementID}"
          class="menupad"
          style="${ifDefined($ProductFormType === "TALL" ? "display: none;" : undefined) }"
          @change=${Receive_ImageGeneartorDecorationImageSourceTypeOnChnage}
        >
          <option selected disabled class="menupad">Source Type</option>
          ${$DecorationSourceOptions.map(
            $DecorationSourceOption => html`
              <option>${$DecorationSourceOption}</option>
            `
          )}
        </select>
        ${$ConditionallyAddedInput}
      `
    })

    var $DecorationSourceMenuGroup = document.querySelector('#DecorationSourceMenuGroup')
    render($MenuGroup, $DecorationSourceMenuGroup)
  }

  function New_UGCRelativeURLFromURL ({
    $URL
  }) {
    var $UGCURLObject = new URL($URL)
    return $UGCURLObject.pathname.split("/").slice(-3).join("/")
  }

  async function Get_ImageGeneratorDecorationImageSourceURL ({
    $Width,
    $Height,
    $AsScene7SrcValue
  }) {
    var $DecorationImageSourceType = Get_ImageGeneratorDecorationImageSourceType()

    var $DecorationImageSourceValue =
      document.querySelector("#DecorationImageSourceValue") ?
      document.querySelector("#DecorationImageSourceValue").value :
      undefined

    if ($DecorationImageSourceType === "UGC Upload" ) {
      return New_TervisAdobeScene7URL({
        $AsScene7SrcValue,
        $Type: "ImageServer",
        $RelativeURL: New_UGCRelativeURLFromURL({$URL: $DecorationImageSourceValue}),
        $Width,
        $Height
      })
    } else if ($DecorationImageSourceType === "Deocoration Image URL") {
      return New_TervisAdobeScene7URL({
        $AsScene7SrcValue,
        $Type: "ImageServer",
        $ExternalURL: $DecorationImageSourceValue,
        $Width,
        $Height
      })
    } else if ($DecorationImageSourceType === "Customyzer Project ID") {
      var $ProjectID = $DecorationImageSourceValue

      return New_TervisAdobeScene7CustomyzerArtboardImageURL({
        $ProjectID,
        $Width,
        $Height,
        $AsScene7SrcValue
      })
    } else if ($DecorationImageSourceType === "Raw Material Item Number") {
      return New_TervisAdobeScene7URL({
        $AsScene7SrcValue,
        $Type: "ImageServer",
        $RelativeURL: `tervis/${$DecorationImageSourceValue}`,
        $Width,
        $Height
      })
    }
  }

  function Get_ImageGeneratorSelectedThingsWithColorCodeRelativePath () {
    var $SelectedThingsWithColorCodes = 
      document.querySelectorAll("#select-vignette-object-color-options :checked:not([value='None'])")
      
    return [...$SelectedThingsWithColorCodes].map(
      $SelectedThingWithColorCode => {
        var $ParentCode = $SelectedThingWithColorCode.closest("ul").className
        var $RootCode = $SelectedThingWithColorCode.closest('div.INNER, div.OUTER, div.ACCESSORIES').className
        return `${$RootCode}/${$ParentCode}/${$SelectedThingWithColorCode.value}`
      }
    )
  }

  function Get_ImageGeneratorProductVignetteElementPathToShow () {
    var $SelectedThingsWithColorCodeRelativePaths = Get_ImageGeneratorSelectedThingsWithColorCodeRelativePath()

    var $ElementPathsToShow = [
      "MAIN/GLARE"
    ]

    $SelectedThingsWithColorCodeRelativePaths.forEach(
      $Path =>
      $ElementPathsToShow.push(`MAIN/${$Path}`)
    )
    return $ElementPathsToShow
  }

  async function Update_ImageGeneratorAllTheThings() {
    
  }

  function Get_ImageGeneratorDecorationImageSourceArced () {
    var $DecorationSourceImageArced = document.querySelector("#DecorationImageSourceArced").value

    if ($DecorationSourceImageArced === "true") {
      return true
    } else if ($DecorationSourceImageArced === "false" ) {
      return false
    } else {
      return undefined
    }
  }

  async function Get_ImageGeneratorProductVignetteImageURL({
    $Width,
    $Height,
    $AsScene7SrcValue,
    $RotationDegrees,
    $DecorationPositionXValue
  }) {
    var $ProductSizeAndProductFormType = Get_ImageGeneratorSelectedProductSizeAndProductFormType()
    var $ImageSourceURLAsScene7SrcValue = await Get_ImageGeneratorDecorationImageSourceURL({
      $AsScene7SrcValue: true
    })

    var $VignetteElementPathToShow = Get_ImageGeneratorProductVignetteElementPathToShow()
    var $DecorationImageSourceIsArced = Get_ImageGeneratorDecorationImageSourceArced()
    var $ProductVignetteNameSuffix = Get_ImageGeneratorProductImageTypeValue()
    var $ProductDecorationTypeCode = Get_ImageGeneratorProductDecorationType()

    if ($DecorationPositionXValue === undefined) {
      if ($RotationDegrees === undefined) {
        $RotationDegrees = document.querySelector("#ProductVignetteRotationDegrees").value
      }

      $DecorationPositionXValue = await ConvertTo_TervisAdobeScene7VignettePosition({
        ...$ProductSizeAndProductFormType,
        $Degrees: $RotationDegrees
      })
    }

    var $DecorationSrc
    if ($ProductDecorationTypeCode && $ImageSourceURLAsScene7SrcValue) {
      if ($DecorationImageSourceIsArced) {
        $ImageSourceURLAsScene7SrcValue = New_TervisAdobeScene7PrintSingleURL({
            ...$ProductSizeAndProductFormType,
            $DecorationType: $ProductDecorationTypeCode,
            $AsScene7SrcValue: true,
            $ImageSrcValue: $ImageSourceURLAsScene7SrcValue
        })
      }

      $DecorationSrc = New_TervisAdobeScene7WrapDecoration3TimesURL({
        ...$ProductSizeAndProductFormType,
        $AsScene7SrcValue: true,
        $DecorationType: $ProductDecorationTypeCode,
        $RepeatedImageSource: $ImageSourceURLAsScene7SrcValue
      })
    }

    return New_TervisAdobeScene7ProductVignetteImageURL({
      ...$ProductSizeAndProductFormType,
      $VignetteSuffix: $ProductVignetteNameSuffix,
      $DecorationSrc,
      $DecorationPositionXValue,
      $ElementPathsToShow: $VignetteElementPathToShow,
      $AsScene7SrcValue,
      $Width,
      $Height
    })
  }

  async function Update_ImageGeneratorProductVignetteURL() {
    var $ProductVignetteURL = await Get_ImageGeneratorProductVignetteImageURL({
      $Width: 545,
      $Height: 480
    })

    document.querySelector("#ProductImagePreview").src = `${$ProductVignetteURL}`
    var $URLPrettyPrint = Out_AdobeScene7URLPrettyPrint({$URL: $ProductVignetteURL})
    Set_ImageGeneratorProductVignetteURL({$URL: $URLPrettyPrint})
  }
  
  //Needed for degrees form element events, to eliminate this refactor slider into lit-html template
  window.Update_ImageGeneratorProductVignetteURL = Update_ImageGeneratorProductVignetteURL

  function Set_ImageGeneratorProductVignetteURL ({
    $URL
  }) {
    document.querySelector("#ProductVignetteURL").value = $URL
  }

  function Add_ImageFromDevice(e) {
    var sharedSecret = '9f91ce08-1501-459f-ab09-3d2ddc103344';
    var bar = $('.progress-bar');
    var percent = $('.percent');
    var status = $('#status');
    console.log("called AddImageFromDevice");

    var validFileTypes = ".bmp .jpg, .jpeg, .png";
    if (FileTypeValidate("txtUploadFile", validFileTypes, "lblFileImageType", "lblFileSelect")) {
      console.log("validated");
      document.querySelector("#UGCUploadLoader").style.display = "inline"

      var UploadToken = '';
      var vXMLResponse = '';

      var urlScene7 = `https://s7ugc1.scene7.com/ugc/image?op=get_uploadtoken&shared_secret=${sharedSecret}&expires=1800`;
      console.log("getting upload token from: " + urlScene7);

      $.ajax({
        url: urlScene7,
        timeout: 50000,
        async: true,
        dataType: "xml",
        success: function (s7TokenXml) {
          console.log(s7TokenXml)

          UploadToken = $(s7TokenXml).find('user_generated_content').find('response').find('message').find('uploadtoken').text();
          console.log(UploadToken);

          var urlUpload = 'https://s7ugc1.scene7.com/ugc/image?op=upload&upload_token=' + UploadToken + '&company_name=tervisRender&preserve_colorprofile=true';
          console.log("calling upload URL: " + urlUpload);

          var options = {
            url: urlUpload,
            async: false,
            error: function (err) {
              console.log(err);
            },
            beforeSend: function () {
              console.log("beforeSend");
              status.empty();
              var percentVal = '0%';
              bar.width(percentVal)
              percent.html(percentVal);
            },
            uploadProgress: function (event, position, total, percentComplete) {
              console.log("uploadProgress");
              var percentVal = percentComplete + '%';
              bar.width(percentVal)
              percent.html(percentVal);
            },
            success: function (uploadImageXml) {
              console.log("uploadImageXml success");

              var xmlstr = uploadImageXml.xml ? uploadImageXml.xml : (new XMLSerializer()).serializeToString(uploadImageXml);

              var $xml = $(uploadImageXml);
              var $ugcStatus = $xml.find('serviceStatus');
              var $ugcStatusDetail = $xml.find('title');

              if ($ugcStatus.text() != "SUCCESS") {
                alert("ERROR UPLOADING IMAGE: " + $ugcStatusDetail.text());
              } else {
                // var $ugcUrl = $xml.find('url');
                // var $ugcPath = $xml.find('path');
                var $ugcFullUrl = $xml.find('fullurl');

                document.querySelector("#DecorationImageSourceValue").value = $ugcFullUrl.text()
                Update_ImageGeneratorProductVignetteURL()
                Set_ImageGeneratorPersistedState()
              }

              var percentVal = '100%';
              bar.width(percentVal)
              percent.html(percentVal);
            },
            complete: function (xhr) {
              console.log("complete");

              document.querySelector("#UGCUploadLoader").style.display = "none"

            },
            cache: false
          };

          console.log("Calling ajaxSubmit");
          $("#frmFileUpload").ajaxSubmit(options);
        },
        error: function (err) {
          document.querySelector("#UGCUploadLoader").style.display = "none"
          console.log(err);
        }
      });
    } else {
      alert("Please upload valid image file");
    }
  }

  function FileTypeValidate(fileControlID, validFileTypes, lblFileTypes, lblFileSelect) {
    var fileUpload = $('#' + fileControlID).val();
    var extension = $('#' + fileControlID).val().substring($('#' + fileControlID).val().lastIndexOf('.'));
    var ValidFileType = validFileTypes;
    if (fileUpload.length > 0) {
      if (ValidFileType.toLowerCase().indexOf(extension.toLowerCase()) < 0) {
        $("#" + lblFileTypes).attr("style", "display:block;color:red;width:250px;");
        $("#" + lblFileSelect).attr("style", "display:none;");
      } else {
        return true;
      }
    } else {
      $("#" + lblFileSelect).attr("style", "display:block;color:red;width:250px;");
      $("#" + lblFileTypes).attr("style", "display:none;");
    }
    return false;
  }

  async function Receive_ImageGeneratorQueryStringParameter() {
    var {
      $ProductSize,
      $ProductFormType,
      $CustomyzerProjectID,
      $EnvironmentName,
      $DownloadButtonActionName,
      $HideUI
    } = Object.fromEntries(
      [...(new URLSearchParams(window.location.search)).entries()]
      .map(
        ([$Name, $Value]) =>
        [`$${$Name}`, $Value]
      )
    )

    if ($HideUI === "true") {
      document.querySelector("#MainContainer").style.display = "none"
      document.querySelector("#HiddenUIMessage").style.display = "inline"
    }

    if ($ProductSize && $ProductFormType) {
      await Set_ImageGeneratorSelectedProductSizeAndProductFormType({ $ProductSize, $ProductFormType })
    }

    if ($CustomyzerProjectID) {
      Set_ImageGeneratorDecorationImageSource({
        $Type: "Customyzer Project ID",
        $Value: $CustomyzerProjectID,
        $ArcedValue: false
      })
    }

    if ($DownloadButtonActionName) {
      Set_NodeValueAndFireOnChange({$ID: "DownloadButtonActionName", $Value: $DownloadButtonActionName})
      Invoke_ImageGeneratorDownload()
    }
  }

  async function Initialize_ImageGenerator () {
    Update_ImageGeneratorDownloadButtonForm()
    Update_ImageGeneratorProductImageTypeContainer()
    await Update_ImageGeneratorProductCarousel()
    await Update_ImageGeneratorThingsWithColorOptionsCarousel()
    Update_ImageGeneratorProductDecorationTypeSelect()
    await Update_ImageGeneratorDecorationImageSourceForm()
    Update_ImageGeneratorDecorationImageSourceFormArcedSelect()
    await Update_ImageGeneratorProductVignetteURL()
    await Get_ImageGeneratorPersistedState()
    await Receive_ImageGeneratorQueryStringParameter()
  }

  window.addEventListener('load', async (event) => {
    await Initialize_ImageGenerator()
  })
</script>